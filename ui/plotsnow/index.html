<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>Snow Cumulation</title>

	<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes' />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
	<script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>



	<style>
	body { margin:0; padding:0; }
	#map { position:absolute; top:15%; bottom:15%; width:100%; }
	</style>
</head>
<body>

	<div id='title'><h1>Snow cumulation </h1></div>
	<div id='form'>
		<form id='formcontent'>
			<input type="date" name="holidays" id="period" value="2013-01-31" class="box" onclick="updateMap()"><br \>
			<!-- <input type="submit" name="submit" value="Display" class="btn">-->
		</form>
	</div>

	<div id='map'></div>

	<!-- <script src="snowcumulation.js" type="text/javascript"></script> -->

	<script>

// This example will run with just Leaflet, without the Mapbox.js
// dependency. Use Leaflet v0.6.3 or newer.

// In the URL below, replace 'examples.map-zr0njcqy' with your map id.
var mapboxTiles = L.tileLayer('https://{s}.tiles.mapbox.com/v3/aubry.i3j7cknp/{z}/{x}/{y}.png', {
	attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
});
var map = L.map('map')
.addLayer(mapboxTiles)
.setView([35.552, -85.429], 5);

 //    geojson = L.geoJson(snow, {

	// 		style: function (feature) {
	// 		return {
	// 			color: getColor(feature.properties.value),
	// 			fillOpacity:0.9
	// 		}
	// 		},

	// 		pointToLayer: function (feature, latlng) {
	// 			return L.circleMarker(latlng);
	// 		},

	// 		onEachFeature: onEachFeature

	// }).addTo(map);


//initial data (week 52 of year 2013)
$.getJSON("data/snowcumulation-2013-52.json", function(snow) {
	//When GeoJSON is loaded
	geojson = L.geoJson(snow, {
		style: function (feature) {
			return {
				color: getColor(feature.properties.value),
				fillOpacity: getOpacity(feature.properties.value)
			}
		},

		pointToLayer: function (feature, latlng) {
			return L.circleMarker(latlng);
		},

		onEachFeature: onEachFeature

        //onEachFeature: onEachFeature,
        });//.addTo(map);

	layersGroup = L.layerGroup()
	layersGroup.addLayer(geojson)
	map.addLayer(geojson);	//Add layer to map	
});


//show a popup with the value when clicking
function onEachFeature(feature, layer) {
	var popupContent = "<p>Snow cumulation of the week: " +
	feature.properties.value + "</p>";

	if (feature.properties && feature.properties.popupContent) {
		popupContent += feature.properties.popupContent;
	}

	layer.bindPopup(popupContent);
}

function updateMap(){
	//map.removeLayer(geojson)
	layerArray = layersGroup.getLayers()
	for(i = 0; i < layerArray.length; ++i){
		map.removeLayer(layerArray[i])
	}

	layersGroup.clearLayers()




	var date = $("#period").val(); // YYYY-MM-DD
	var week = moment(date).week()
	var year = moment(date).year()

	var weekFormatted = week < 10 ? '0' + week : week

	var fileName = "snowcumulation-" + year+ "-" + weekFormatted +".json";



 	$.getJSON("data/" + fileName, function(snow) {
	//When GeoJSON is loaded
	geojson = L.geoJson(snow, {
		style: function (feature) {
			return {
				color: getColor(feature.properties.value),
				fillOpacity: getOpacity(feature.properties.value)
				//console.log("alut")
			}
		},

		pointToLayer: function (feature, latlng) {
			return L.circleMarker(latlng);
		},

		onEachFeature: onEachFeature

        //onEachFeature: onEachFeature,
        });//.addTo(map);
	map.addLayer(geojson);	//Add layer to map
	layersGroup.addLayer(geojson)	
});
 }


// $("#formcontent").submit(function(event) {
//  	event.preventDefault();
//  	var date = $("#period").val().split('-W');
//  	var year = date[0]
//  	var week = date[1]
//  	var fileName = "snowcumulation-" + date[0]+ "-" +date[1]+".json";



//  	//alert(fileName);
//  	//map.removeLayer(geojson);

//  	//var snow = require('snowcumulation.json');

//  	document.getElementById('title').innerHTML = date + " - " + fileName;

// 	map.removeLayer(geojson);

// $.getJSON("data/" + fileName, function(snow) {
// 	//When GeoJSON is loaded
// 	geojson = L.geoJson(snow, {
// 			style: function (feature) {
// 			return {
// 				color: getColor(feature.properties.value),
// 				fillOpacity:0.9
// 			}
// 			},

// 			pointToLayer: function (feature, latlng) {
// 				return L.circleMarker(latlng);
// 			},

// 			onEachFeature: onEachFeature

//         //onEachFeature: onEachFeature,
//         });//.addTo(map);
// 	//var geojsonLayer = new L.GeoJSON(data);	//New GeoJSON layer
// 	map.addLayer(geojson);	//Add layer to map	
// 	});

//  });





function getColor(snowCumulation){
	var gradient = ["#B33409", "#B83E07", "#BE4806", "#C35204", "#C95C03", "#CE6601", "#D47100", "#D7870C", "#DA9D19", "#DDB326", "#E0C932", "#E3DF3F", "#E7F54C", "#D4EE46", "#C1E840", "#AFE23A", "#9CDB34", "#89D52E", "#77CF29", "#70D141", "#69D459", "#62D771", "#5BDA89", "#54DDA1", "#4EE0B9", "#3FB9C3", "#3092CD", "#216BD8", "#1144E2", "#031EED"];
	return snowCumulation > 500 ? gradient[1] :
			snowCumulation > 300 ? gradient[3] :
			snowCumulation > 250 ? gradient[5] :
			snowCumulation > 200 ? gradient[7] :
			snowCumulation > 175 ? gradient[9] :
			snowCumulation > 150 ? gradient[11] :
			snowCumulation > 125 ? gradient[13] :
			snowCumulation > 100 ? gradient[15] :
			snowCumulation > 75 ? gradient[17] :
			snowCumulation > 50 ? gradient[19] :
			snowCumulation > 30 ? gradient[21] :
			snowCumulation > 20 ? gradient[23] :
			snowCumulation > 10 ? gradient[25] :
			snowCumulation > 5 ? gradient[27] :
			snowCumulation > 0 ? gradient[29] :
			'#267cc4';
		}


		function getOpacity(snowCumulation){
			var opacity = [0.6, 0.8, 0.9, 1];
			return snowCumulation > 500 ? opacity[3] :

			snowCumulation > 100 ? opacity[3] :

			snowCumulation > 50 ? opacity[2] :

			snowCumulation > 15 ? opacity[1] :

			snowCumulation > 0 ? opacity[0] :
			0.4;
		}

		</script>


	</body>
	</html>